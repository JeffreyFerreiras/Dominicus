@page
@using Dominicus.Razor.Pages
@using Dominicus.Razor.Pages.Shared.Components
@model IndexModel
@{
    ViewData["Title"] = "Dominicus";
}

<link rel="stylesheet" href="~/css/chat.css" />

<div class="chat-container">
    <div class="chat-header">
        <h1 class="dominican-header">Dominicus</h1>
        <p class="text-gradient">Your Dominican Spanish AI Assistant</p>
    </div>

    <div class="chat-messages" id="chatMessages">
        @if (Model.ConversationHistory.Any())
        {
            foreach (var conversation in Model.ConversationHistory)
            {
                <ChatMessage IsUser="true"
                            Question="@conversation.Question" />

                <ChatMessage IsUser="false"
                            EnglishResponse="@conversation.EnglishResponse"
                            DominicanResponse="@conversation.DominicanResponse" />
            }
        }
        else
        {
            <div class="empty-state text-center">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <h3>Start a Conversation</h3>
                <p>Ask me anything and I'll respond in both English and Dominican Spanish!</p>
            </div>
        }
    </div>

    <div class="chat-input">
        <form method="post" id="questionForm" class="needs-validation" novalidate>
            <div class="input-group">
                <textarea asp-for="Question" 
                         class="form-control" 
                         rows="1"
                         placeholder="Type your message..."
                         required
                         onkeydown="handleKeyPress(event)"></textarea>
                <button type="submit" class="btn btn-primary">
                    <span class="button-text">
                        <i class="fas fa-paper-plane"></i>
                    </span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </form>

        <div class="suggested-questions">
            @foreach (var question in Model.SuggestedQuestions)
            {
                <button class="btn btn-outline-secondary btn-sm suggested-question">
                    @question
                </button>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                document.getElementById('questionForm').submit();
            }
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        document.querySelectorAll('.suggested-question').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const textarea = document.querySelector('#Question');
                textarea.value = this.textContent.trim();
                textarea.focus();
            });
        });

        document.getElementById('questionForm').addEventListener('submit', function(e) {
            const submitButton = this.querySelector('button[type="submit"]');
            const buttonText = submitButton.querySelector('.button-text');
            const spinner = submitButton.querySelector('.spinner-border');
            
            if (this.checkValidity()) {
                buttonText.classList.add('invisible');
                spinner.classList.remove('d-none');
            }
        });

        // Auto-resize textarea
        const textarea = document.querySelector('#Question');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Scroll to bottom on page load and after new messages
        window.addEventListener('load', scrollToBottom);
        if (window.location.href.includes('?handler=')) {
            scrollToBottom();
        }
    </script>
}
